## PRD: 로컬 유튜브 다운로드 웹앱 (yt-dlp 기반)

### 개요
- **목적**: 오픈소스 `yt-dlp`를 활용해 유튜브 컨텐츠를 로컬에서 손쉽게 다운로드하는 웹 UI 제공.
- **범위**: 동영상은 MP4, 오디오는 MP3 형식으로 다운로드. 로컬 환경에서만 동작(오프라인 지향), 서버/클라이언트 모두 로컬 머신에서 실행.
- **비용 목표**: 0원. 유료 API/클라우드 사용 금지. 오픈소스만 사용.

### 배경
- CLI 중심의 yt-dlp는 강력하지만 비개발자에게 사용성이 낮음. 최소 UI를 제공해 URL 입력 → 형식 선택 → 다운로드 과정을 단순화.

### 목표 (Success Criteria)
- 사용자는 유튜브 URL을 입력하고, 형식(Video MP4 / Audio MP3)을 선택해 3클릭 이내 다운로드.
- 진행률(Progress) 및 상태 메시지를 UI로 확인 가능.
- 기본 설정으로 다운로드 파일이 로컬 지정 폴더에 저장.
- 네트워크 불안정/포맷 미지원 등 오류에 대해 일반적이고 친절한 가이던스 제공.

### 비목표 (Out of Scope)
- 계정 로그인, 재생목록/채널 대량 동시 다운로드(초기 버전 제외), 자막/챕터/썸네일 별도 추출(추후 로드맵), 스트리밍 기능 제공, 멀티 유저 서버 배포.

### 주요 사용자
- 개인 사용자(비개발자 포함), 내부 툴 사용자. 로컬 PC에서 간단히 미디어를 보관하려는 유저.

### 사용자 시나리오
1. 사용자가 웹 UI를 로컬에서 열기.
2. 유튜브 URL을 입력.
3. 형식 선택: Video(MP4) 또는 Audio(MP3).
4. 필요 시 품질(자동/최고/선택) 선택(초기에는 자동 또는 최고만 제공).
5. 다운로드 버튼 클릭 → 진행률 표시 → 완료 후 저장 위치 안내 및 파일 열기 버튼 제공.

### 기능 요구사항
- URL 입력 필드, 형식 선택 토글/라디오(MP4 vs MP3), 다운로드 버튼 제공.
- 다운로드 진행률(퍼센트/바) 및 상태 로그 영역 표시.
- 기본 저장 경로: 앱 루트 하위 `downloads/` (없으면 생성). 사용자 지정 경로는 v2 로드맵.
- 파일명 규칙: `{title}_[{id}]_{quality}.{ext}` (공백/문자 제한은 안전 문자로 치환).
- 비디오: MP4 컨테이너(h264+aac 우선), 실패 시 yt-dlp 기본 최적 포맷 합성.
- 오디오: MP3 128kbps 이상(가능 시 192kbps). 원본 오디오 추출 후 ffmpeg 트랜스코딩.
- 최근 다운로드 5개 내역(파일명/형식/완료시간/열기) 표시.
- 다운로드 취소 버튼 제공(작업 중단).

### 시스템/아키텍처 요구사항
- 전제: 로컬 머신에 `Python 3.10+`, `ffmpeg`, `yt-dlp` 설치.
- 백엔드: FastAPI 기반 로컬 서버, `yt-dlp`를 직접 호출하여 포맷 조회/다운로드 수행.
- 프런트엔드: 단일 페이지(웹) UI. 순수 HTML/CSS/JS 사용.
- 통신: HTTP API(현 구현 기준)
  - `GET /api/health`
  - `GET /api/formats?url=<youtube_url>`
  - `GET /api/download?url=<youtube_url>&type=video|audio&format_id=<format_id>`
- 저장소: 로컬 파일시스템만 사용. 별도 DB 없음.
 - 배포: uv 기반 로컬 실행(uv sync/run), 선택적으로 Docker 이미지로 실행 가능(포트 3001 노출, downloads 마운트 권장).

### 비기능 요구사항(NFR)
- 성능: 단일 다운로드 기준 UI의 진행률 업데이트 최소 500ms 주기. 동시 2건까지 안정 동작.
- 신뢰성: 오류 발생 시 중간 파일 정리(임시 파일 삭제) 및 재시도 가이드 제공.
- 보안: 로컬 호스트에서만 접근(기본 바인딩 `127.0.0.1`). 외부 노출 금지.
- 프라이버시/로그: 민감정보 수집 금지. 로그는 로컬만 기록, 7일 보관/회전.
- i18n: 초기 한국어 고정.

### 에러 처리 및 메시지 정책
- 사용자 메시지: "다운로드 중 오류가 발생했습니다. 네트워크를 확인하고 다시 시도하세요."와 같은 일반 안내 제공.
- 내부 로그: 예외 스택/원인(지원 불가 포맷, 네트워크, 권한, 저장 공간 부족 등) 상세 기록.
- 사용자가 취할 수 있는 조치 안내: URL 확인, 네트워크 확인, 저장 공간 확보, `ffmpeg` 설치/경로 확인, 다른 품질로 재시도.

### 외부 의존성(모두 무료/오픈소스)
- `yt-dlp`: 다운로드/병합/포맷 선택.
- `ffmpeg`: 포맷 변환(MP3 트랜스코딩, MP4 병합).
- Python 표준/경량 라이브러리(Flask, pathlib, subprocess 등).

### 데이터 및 파일 구조
- `downloads/` 폴더: 결과 파일 저장 루트.
- `downloads/tmp/`: 임시 파일 저장.
- `downloads/history.json`: 최근 내역(최대 50) 저장.

### 법적/정책 고려
- 사용자 책임 고지: 콘텐츠 이용 약관/저작권을 준수해야 함. 앱은 개인적/합법적 사용만을 목적으로 함.
- 지역/플랫폼 정책 변경에 따른 동작 불가 가능성 고지.

### UI 개요(초안)
- 상단: 제목/간단 설명.
- 본문: URL 입력, 형식 선택(MP4/MP3), 품질 선택(최고/자동), 다운로드 버튼.
- 하단: 진행률 바, 상태 메시지, 최근 내역 리스트(열기 버튼, 파일 위치 열기 링크).

### 수용 기준(Acceptance Criteria)
- MP4/MP3 각각 1개 이상 URL로 정상 다운로드/저장.
- 진행률 바가 0→100%로 자연스럽게 갱신.
- 오류 시 사용자 안내 메시지와 내부 로그 기록 동시 수행.
- 기본 저장 폴더 자동 생성 및 파일명 규칙 반영.
- 최근 내역에 최신 항목이 즉시 반영되고 열기 동작 가능.

### QA 체크리스트
- 정상/에러/취소 플로우 각각 검증.
- 네트워크 차단 상태, 공간 부족, ffmpeg 미설치 시나리오 처리 확인.
- Windows/macOS/Linux 경로/권한 차이 최소 동작 확인(초기 macOS 우선).

### 릴리스 범위(v1)
- 단일 URL 다운로드, 포맷(MP4/MP3) 전환, 진행률 표시, 최근 내역, 취소.
- 로컬 전용 실행 스크립트 제공.

### 리스크 및 대응
- TOS/저작권 이슈: 고지 및 사용 책임 명시, 내부 배포 한정.
- 포맷/코덱 가용성: yt-dlp/ffmpeg 업데이트 가이드 제공.
- 플랫폼 변경: 의존 버전 명시 및 정기 업데이트 체크.

### 로드맵(v2+)
- URL 유효성 사전 검사, 품질 상세 선택(해상도/비트레이트), 자막/썸네일 옵션, 다중 큐, 드래그&드롭, 프록시 지원, 자동 업데이트 체크.

### 성공 지표
- 첫 시도 성공률 ≥ 95% (샘플 20건).
- 평균 다운로드 시작까지 대기 < 2초(로컬 기준, 네트워크 제외).
- 에러 후 재시도 성공률 ≥ 80%.

---
title: 유튜브 다운로드 웹앱 PRD (yt-dlp 기반)
owner: Platform/AI Team
version: 1.0.0
status: Draft
last_updated: 2025-08-11
---

## 1. 제품 개요

본 문서는 `yt-dlp` 소스를 활용하여 유튜브 컨텐츠를 다운로드할 수 있는 웹 애플리케이션(이하 ‘본 서비스’)의 제품 요구사항을 정의한다. 사용자는 브라우저에서 URL을 입력하고 다음을 수행할 수 있다.

- 영상: mp4 형식 다운로드 (가능한 경우 오디오 포함 ‘progressive’ MP4 우선)
- 오디오: mp3 형식 다운로드 (브라우저 내 ffmpeg.wasm 변환 흐름 지원)

운영/배포 타깃은 Vercel이며, 월 비용 0원을 목표로 한다. 법적/정책 준수를 위해 다음 원칙을 따른다.

- 기본값: 서버를 통한 미디어 프록시/전송 금지(대역폭 비용 발생 차단). 서버는 링크 추출 또는 메타데이터 제공에 한정.
- 변환은 가능한 한 클라이언트 로컬(브라우저)에서 수행(ffmpeg.wasm). 원본 미디어 획득은 사용자가 직접 브라우저를 통해 다운로드.
- yt-dlp 사용은 ‘링크/포맷 메타데이터 추출’ 역할로 한정(프록시 다운로드 금지). 0원 조건을 충족하기 어렵거나 배포 제약이 있을 경우 대체 Provider(예: Piped/Invidious 공용 인스턴스)에 폴백.


## 2. 목표와 비목표

### 2.1 목표
- 유튜브 URL 입력만으로 간단히 mp4/mp3를 획득할 수 있는 UX 제공
- 서버 대역폭 비용 발생을 최소화(0원 목표)하며, 변환은 브라우저에서 처리
- 모바일/데스크톱 브라우저 호환(최근 버전 Chrome/Edge/Firefox/Safari)
- 접근성 준수(키보드 네비게이션, ARIA), i18n 확장성 고려

### 2.2 비목표
- 서버 측에서 미디어 파일을 다운로드/병합/변환/저장/전달하지 않음(대역폭 비용 발생 방지)
- 로그인/사용자 계정/결제/클라우드 저장소 업로드 제공하지 않음
- DRM 보호 컨텐츠, 유료 컨텐츠는 지원하지 않음


## 3. 주요 사용자 시나리오

1) 사용자는 유튜브 URL을 입력 → 포맷 탐색 결과가 표시됨(권장 MP4, 오디오 전용 스트림 등).
2) 영상(mp4): ‘다운로드’ 버튼 클릭 → 브라우저가 `googlevideo` 등 CDN 링크로 직접 내려받기 시작(서버 프록시 없음).
3) 오디오(mp3): 먼저 오디오 전용 원본(m4a/webm)을 내려받은 뒤, 페이지의 ‘파일 드롭존’에 파일을 끌어다 놓으면 ffmpeg.wasm이 mp3로 변환 → 결과 파일 저장.
4) 영상 병합(필요 시): 특정 영상이 ‘영상만(비프로그레시브)’ 스트림만 제공될 경우, 영상(.mp4/.webm)과 오디오(.m4a/.webm)을 모두 다운로드한 뒤, 드롭존에 두 파일을 올려 브라우저 내 병합(mp4) 진행.


## 4. 요구사항

### 4.1 기능 요구사항
- URL 입력 및 검증(유효성, 지원 도메인)
- 포맷 탐색 결과 표시: 제목, 썸네일, 길이, 해상도, 코덱, 파일 크기(가능 시), 예상 품질
- 영상 다운로드(mp4): progressive MP4 우선 제공, 없으면 대체 옵션 안내
- 오디오 다운로드(mp3): 원본 오디오 스트림 다운로드 + 브라우저 내 mp3 변환
- 진행 상태 표시: 포맷 탐색 진행, 변환 진행률, 완료/실패 상태
- 파일명 템플릿: `<title>_[<quality>].<ext>` (불법 문자 제거)
- 오류 메시지: 일반화된 사용자 메시지 + 세부 로그는 콘솔/개발자용 뷰에 분리
- 기록: 최근 5개 다운로드 항목 로컬 캐시(브라우저 저장)
- 접근성: 키보드 포커스, 스크린리더 대응

### 4.2 비기능 요구사항
- 비용: 월 0원(서버 대역폭 거의 0, 함수 호출 소량)
- 성능: 포맷 탐색 응답 < 3초(네트워크 상황에 따라 상이), 변환은 디바이스 성능 의존
- 보안/프라이버시: URL 이외 민감 데이터 미수집, 서버 로그 최소화/비식별화
- 가용성: Vercel 무료 플랜 기준 SLA 비적용, 장애 시 폴백 Provider 사용
- 브라우저 호환성: 최근 2개 메이저 버전 우선, iOS Safari에서 ffmpeg.wasm 성능 제한 고지

### 4.3 정책/법적 고려
- 서비스는 개인적/합법적 사용 범위에서만 이용하도록 고지
- YouTube 약관/저작권 정책 위반 컨텐츠 사용 금지 경고 및 책임 고지 표시
- 공용 Provider 사용 시 해당 서비스 정책/레이트리밋 준수


## 5. 시스템 아키텍처(0원 지향)

### 5.1 구성 요소
- Web 프론트엔드: Next.js(Vercel) + Tailwind(또는 Chakra) + ffmpeg.wasm
- 링크/포맷 추출 Provider 추상화: 
  - Provider A(기본): Piped API(공용 인스턴스) 사용하여 스트림 URL 메타 수집
  - Provider B(선택): yt-dlp 실행 기반 추출(자체 호스팅 또는 사용자가 제공한 엔드포인트). Vercel 배포 시에는 바이너리/런타임 제약으로 기본 미적용

### 5.2 데이터 흐름
1) 클라이언트가 `/api/extract` 호출(Provider A → 공용 API) → 포맷 리스트 수신
2) 클라이언트가 직접 CDN(googlevideo 등)로 다운로드(앵커 링크/새 탭 열기). 서버 프록시 없음
3) 오디오 mp3 변환 또는 영상 병합은 브라우저 내 ffmpeg.wasm으로 수행(사용자 파일 드롭 기반)

### 5.3 0원 유지 전략
- 서버에서 미디어 바이트를 중계하지 않음(대역폭 비용 제로)
- API 호출 수 최소화, 요청 결과 캐싱(브라우저/서버 측 단기 캐시)
- 공용 Provider 사용(장애 시 다른 인스턴스로 폴백 가능)


## 6. API 설계(내부/프록시 계층)

본 서비스는 공용 Provider에 직접 호출하는 대신, 얇은 서버리스 프록시를 둔다. 목적은 CORS 정리, 호출 규격 통일, 레이트리밋/캐시, 취약점 차단이다. 단, 미디어 데이터 프록시는 금지.

### 6.1 엔드포인트
- GET `/api/extract?url=<youtube_url>&type=<video|audio|all>`
  - 응답 200(JSON):
    ```json
    {
      "title": "string",
      "thumbnailUrl": "string",
      "durationSec": 1234,
      "video": [
        {"itag": 22, "ext": "mp4", "hasAudio": true, "width": 1280, "height": 720, "fps": 30, "bitrate": 2000000, "url": "https://..."}
      ],
      "audio": [
        {"itag": 140, "ext": "m4a", "abr": 128, "url": "https://..."}
      ],
      "provider": "piped|yt-dlp",
      "fetchedAt": "ISO8601"
    }
    ```
  - 오류: 4xx(입력 오류/지원 불가), 5xx(Provider 장애). 바디에는 일반화된 메시지만 반환.

### 6.2 레이트리밋/캐싱
- IP/URL 기반 소규모 레이트리밋(예: 초당 1, 분당 10)
- 동일 URL 단기 캐시(예: 5분)로 Provider 호출 절감

### 6.3 Provider 교체성
- 기본은 Piped API. 환경변수로 Provider 전환 가능(`PROVIDER=piped|ytdlp`)
- `ytdlp` 모드는 별도 자가 호스팅 엔드포인트를 호출(예: Fly.io, 개인 VPS)하여 Vercel 함수에서는 프록시/정규화만 수행


## 7. 프론트엔드 UX 요구사항

- 단일 페이지 흐름: URL 입력 → 포맷 결과 → 액션 버튼(다운로드/변환) → 상태/완료
- 품질 선택: 자동 권장(‘권장 MP4’), 수동 선택 드롭다운(해상도/코덱)
- mp3 변환:
  - 1단계: 오디오 원본 파일 다운로드 안내
  - 2단계: 드롭존에 파일 올리면 변환 시작(진행률/예상 시간 표시)
- 병합(옵션): 영상/오디오 두 파일을 드롭하면 브라우저 내 병합(mp4) 수행
- 에러/안내 문구: 
  - 일반 사용자 문구(“문제가 발생했습니다. 다시 시도해 주세요.”)
  - 개발자 상세(콘솔/토글 패널)에 원인 로그


## 8. 에러 처리 정책(사용자 가이드 포함)

- 입력 오류: 잘못된 URL → “URL을 확인해 주세요.”
- Provider 장애/레이트리밋: “일시적 문제입니다. 잠시 후 다시 이용해 주세요.” 폴백 인스턴스 안내
- 다운로드 거부/403: “원본 서버에서 다운로드를 허용하지 않습니다. 새 탭에서 링크를 직접 여시거나 다른 품질을 시도해 주세요.”
- 변환 실패(ffmpeg.wasm): “브라우저 자원이 부족합니다. 다른 브라우저나 데스크톱 환경에서 다시 시도해 주세요.”


## 9. 보안/프라이버시

- URL 외에 사용자 개인 데이터 저장 금지
- 서버 로그 최소화(요약 수준, IP 해시/부분 마스킹)
- CSP/코드 무결성, 의존성 서드파티 검증


## 10. 성능/지표

- 핵심 지표(KPI)
  - 포맷 탐색 성공률 ≥ 95%
  - 링크 클릭 후 브라우저 다운로드 시작까지 중앙값 < 2s
  - 브라우저 mp3 변환 성공률 ≥ 90%(모바일 제외 시 ≥ 95%)

- 모니터링
  - 클라이언트 이벤트(익명): 탐색 성공/실패, 변환 성공/실패, 소요 시간
  - 서버: `/api/extract` 성공/오류율, Provider별 오류 분포


## 11. 배포/운영(Vercel 0원)

- Runtime: Vercel Serverless Functions(Node.js) + Edge(필요 시)
- 지역: 글로벌(기본), Provider 인접 리전 우선
- 환경변수: `PROVIDER`, `PIPED_BASE_URL`(예: `https://piped.video`), `FALLBACK_PIPED_URLS`
- 대역폭: 서버에서 미디어 바이트 미중계 원칙으로 0원 유지
- 제한: 공용 Provider 변동성/가용성 리스크 수용(장애 시 폴백)


## 12. 마일스톤/일정

- M1(주차 1): 기본 UI, `/api/extract`(Piped), MP4 권장 링크 제공, 다운로드 UX
- M2(주차 2): 브라우저 ffmpeg.wasm 통합(mp3 변환, 1파일 변환), 진행률/오류 처리
- M3(주차 3): 영상/오디오 병합(2파일) 지원, 품질/코덱 고급 옵션, 캐시/레이트리밋
- M4(주차 4): i18n, 접근성 고도화, 안정화/로그/지표 수집
- 옵션: `yt-dlp` 자가 호스팅 Provider 연동(비Vercel 환경 또는 사용자가 제공)


## 13. 리스크와 완화책

- YouTube 정책/차단: 공용 Provider/링크 만료/403 → 폴백 인스턴스, 사용자 직접 새 탭 열기 안내
- 브라우저 변환 성능: 모바일/저사양에서 변환 실패 → 데스크톱 권장, 오디오 128kbps 기본, 병합 시 품질 제한
- Vercel 제약: 바이너리/런타임 제약으로 `yt-dlp` 직접 실행 어려움 → Provider 추상화로 외부/자가 호스팅 연동
- 공용 인스턴스 안정성: 가용성 변동 → 다중 후보 구성, 헬스체크/자동 폴백


## 14. 수용 기준(Acceptance Criteria)

1) 유효한 유튜브 URL 입력 시 3초 내 포맷 목록이 표시되어야 한다(90% 케이스).
2) 권장 MP4를 클릭하면 서버 중계 없이 브라우저 다운로드가 시작되어야 한다.
3) 오디오 전용 파일 다운로드 후 드롭존에 놓으면 mp3 변환이 브라우저에서 완료되어야 한다.
4) 영상/오디오 두 파일을 드롭하면 병합(mp4)이 완료되어야 한다(지원 포맷 한정).
5) 오류 상황에서 일반 사용자 메시지와 개발자 로그가 구분되어 제공되어야 한다.
6) 서버 대역폭 지표가 0에 근접해야 한다(미디어 바이트 중계 없음).


## 15. 부록

### 15.1 파일명 템플릿 규칙
- 금지 문자를 제거: `/\\?%*:|"<>` 등
- 템플릿: `<title>_[<quality_or_abr>].<ext>`

### 15.2 권장 포맷 선택 규칙(의사코드)
```
if type == video:
  # progressive mp4 우선
  pick best where ext == 'mp4' and hasAudio == true
  if none: show best video-only mp4/webm and guide merge
else if type == audio:
  pick best audio-only where ext in ['m4a', 'webm']
```

### 15.3 예시 응답(간략)
```json
{
  "title": "Sample Video",
  "thumbnailUrl": "https://i.ytimg.com/...",
  "durationSec": 321,
  "video": [{"itag": 22, "ext": "mp4", "hasAudio": true, "width": 1280, "height": 720, "fps": 30, "bitrate": 2000000, "url": "https://rr2---sn-...googlevideo.com/..."}],
  "audio": [{"itag": 140, "ext": "m4a", "abr": 128, "url": "https://rr2---sn-...googlevideo.com/..."}],
  "provider": "piped",
  "fetchedAt": "2025-08-11T00:00:00.000Z"
}
```

### 15.4 컴플라이언스 고지 예시
- “본 서비스는 개인적/합법적 사용 범위에서만 이용할 수 있습니다. 저작권이 있는 컨텐츠의 무단 다운로드/배포는 금지되어 있으며 모든 책임은 사용자에게 있습니다.”


